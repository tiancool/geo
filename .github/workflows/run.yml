name: Geo Data Update

on:
  schedule:
    - cron: '0 2 * * 6'  # æ¯å‘¨å…­å‡Œæ™¨2ç‚¹
  workflow_dispatch:
    inputs:
      countries:
        description: 'GeoIP å›½å®¶ä»£ç '
        required: false
        default: 'cloudflare,cloudfront,cn,facebook,google,netflix,private,telegram,twitter'
      sites:
        description: 'GeoSite ç«™ç‚¹ä»£ç '
        required: false
        default: 'google,facebook,netflix,telegram,twitter,youtube'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
        
    - name: Process Geo Data
      run: |
        # ä¸‹è½½ GeoIP æ•°æ®
        curl -L -o geoip.dat https://github.com/Loyalsoldier/geoip/raw/release/geoip.dat
        
        # ä¸‹è½½ GeoSite æ•°æ®
        curl -L -o geosite.dat https://github.com/Loyalsoldier/domain-list-custom/releases/latest/download/geosite.dat
        
        # ä½¿ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶
        chmod +x geo
        
        # å¤„ç† GeoIP æ•°æ®
        COUNTRIES="${{ github.event.inputs.countries || 'cloudflare,cloudfront,cn,facebook,google,netflix,private,telegram,twitter' }}"
        mkdir -p ip
        ./geo -c $COUNTRIES -o ip/
        
        # å¤„ç† GeoSite æ•°æ®
        SITES="${{ github.event.inputs.sites || 'google,facebook,netflix,telegram,twitter,youtube' }}"
        mkdir -p site
        ./geo -f geosite.dat -s $SITES -o site/
        
        echo "GeoIP å¤„ç†å®Œæˆ: $COUNTRIES"
        echo "GeoSite å¤„ç†å®Œæˆ: $SITES"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        if [ -d "ip" ] && [ "$(ls -A ip)" ] && [ -d "site" ] && [ "$(ls -A site)" ]; then
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet ip/ site/ 2>/dev/null; then
            echo "âœ… æ•°æ®æ— æ›´æ–°ï¼Œè·³è¿‡æäº¤"
            echo "NO_UPDATE=true" >> $GITHUB_ENV
          else
            echo "ğŸ”„ æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ï¼Œå‡†å¤‡æäº¤"
            echo "NO_UPDATE=false" >> $GITHUB_ENV
          fi
        else
          echo "âŒ è¾“å‡ºç›®å½•ä¸ºç©ºï¼Œè·³è¿‡æäº¤"
          echo "NO_UPDATE=true" >> $GITHUB_ENV
        fi
        
    - name: Commit to repo
      if: env.NO_UPDATE == 'false'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add ip/ site/
        
        git commit -m "Update - $(date +'%Y-%m-%d %H:%M')"
        git push
        
    - name: Skip commit
      if: env.NO_UPDATE == 'true'
      run: |
        echo "âœ… æ•°æ®æ— æ›´æ–°ï¼Œè·³è¿‡æäº¤"
        echo "ğŸ“Š å½“å‰æ•°æ®å·²æ˜¯æœ€æ–°ç‰ˆæœ¬" 
