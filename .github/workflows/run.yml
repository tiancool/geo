name: Geo Data Update

on:
  schedule:
    - cron: '0 2 * * 6'  # 每周六凌晨2点
  workflow_dispatch:
    inputs:
      countries:
        description: 'GeoIP'
        required: false
        default: 'cloudflare,cloudfront,cn,facebook,google,netflix,private,telegram,twitter'
      sites:
        description: 'GeoSite'
        required: false
        default: 'apple,bybit,category-ai-!cn,category-cryptocurrency,category-games,category-media,category-public-tracker,category-social-media-!cn,cloudflare,cloudflare-cn,connectivity-check,disney,facebook,geolocation-!cn,github,google,hbo,instagram,microsoft,netflix,openai,onedrive,paypal,paypal@cn,private,tiktok,telegram,twitter,youtube'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
        
    - name: Process Geo Data
      run: |
        # 下载数据
        curl -L -o geoip.dat https://github.com/Loyalsoldier/geoip/raw/release/geoip.dat
        curl -L -o geosite.dat https://github.com/Loyalsoldier/domain-list-custom/releases/latest/download/geosite.dat
        
        # 处理数据
        chmod +x geo
        COUNTRIES="${{ github.event.inputs.countries || 'cloudflare,cloudfront,cn,facebook,google,netflix,private,telegram,twitter' }}"
        SITES="${{ github.event.inputs.sites || 'cn,apple,bybit,category-ai-!cn,category-cryptocurrency,category-games,category-media,category-public-tracker,category-social-media-!cn,cloudflare,connectivity-check,disney,facebook,geolocation-!cn,github,google,hbo,instagram,microsoft,netflix,openai,onedrive,paypal,paypal@cn,private,tiktok,telegram,twitter,youtube,spotify' }}"
        
        mkdir -p ip site
        ./geo -c $COUNTRIES -o ip/
        ./geo -f geosite.dat -s $SITES -o site/
        
        # 检查更新
        git add ip/ site/
        if git diff --cached --quiet; then
          echo "✅ 数据无更新"
          git reset
        else
          echo "🔄 检测到更新，提交中..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Update - $(date +'%Y-%m-%d %H:%M')"
          git push
        fi 
