name: Geo Data Update

on:
  schedule:
    - cron: '0 2 * * 6'  # æ¯å‘¨å…­å‡Œæ™¨2ç‚¹
  workflow_dispatch:
    inputs:
      countries:
        description: 'GeoIP å›½å®¶ä»£ç '
        required: false
        default: 'cloudflare,cloudfront,cn,facebook,google,netflix,private,telegram,twitter'
      sites:
        description: 'GeoSite ç«™ç‚¹ä»£ç '
        required: false
        default: 'google,facebook,netflix,telegram,twitter,youtube'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
        
    - name: Process Geo Data
      run: |
        # ä¸‹è½½æ•°æ®
        curl -L -o geoip.dat https://github.com/Loyalsoldier/geoip/raw/release/geoip.dat
        curl -L -o geosite.dat https://github.com/Loyalsoldier/domain-list-custom/releases/latest/download/geosite.dat
        
        # å¤„ç†æ•°æ®
        chmod +x geo
        COUNTRIES="${{ github.event.inputs.countries || 'cloudflare,cloudfront,cn,facebook,google,netflix,private,telegram,twitter' }}"
        SITES="${{ github.event.inputs.sites || 'google,facebook,netflix,telegram,twitter,youtube' }}"
        
        mkdir -p ip site
        ./geo -c $COUNTRIES -o ip/
        ./geo -f geosite.dat -s $SITES -o site/
        
        # æ£€æŸ¥æ›´æ–°
        git add ip/ site/
        if git diff --cached --quiet; then
          echo "âœ… æ•°æ®æ— æ›´æ–°"
          git reset
        else
          echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°ï¼Œæäº¤ä¸­..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Update - $(date +'%Y-%m-%d %H:%M')"
          git push
        fi 
